name: Build Telegram Bot API

on:
  workflow_dispatch:
    inputs:
      enable_lto:
        description: 'Enable Link Time Optimization'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      build_type:
        description: 'Build type'
        required: false
        default: 'Release'
        type: choice
        options:
          - 'Release'
          - 'Debug'
          - 'RelWithDebInfo'
          - 'MinSizeRel'

jobs:
  build:
    name: Build on ${{ matrix.os }} ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: linux
            arch: x86_64
            runner: ubuntu-22.04
            cc: gcc
            cxx: g++
          - os: linux
            arch: arm64
            runner: ubuntu-22.04
            cc: aarch64-linux-gnu-gcc
            cxx: aarch64-linux-gnu-g++
            cross_compile: true

          # macOS
          - os: macos
            arch: x86_64
            runner: macos-13
            cc: clang
            cxx: clang++
          - os: macos
            arch: arm64
            runner: macos-14
            cc: clang
            cxx: clang++
            arch_flags: -arch arm64

          # Windows
          - os: windows
            arch: x86_64
            runner: windows-2022
            cc: cl
            cxx: cl

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies (Linux)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            zlib1g-dev \
            libssl-dev \
            gperf

      - name: Install cross-compilation dependencies (Linux ARM64)
        if: matrix.os == 'linux' && matrix.cross_compile
        run: |
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            qemu-user-static

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install cmake gperf openssl@3

      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake (Linux)
        if: matrix.os == 'linux'
        run: |
          mkdir build
          cd build
          if [ "${{ matrix.cross_compile }}" == "true" ]; then
            export CMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/.github/toolchain-aarch64-linux-gnu.cmake
          fi
          cmake \
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DTELEGRAM_BOT_API_ENABLE_LTO=${{ inputs.enable_lto }} \
            ..

      - name: Configure CMake (macOS)
        if: matrix.os == 'macos'
        run: |
          mkdir build
          cd build
          export OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          cmake \
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DOPENSSL_ROOT_DIR=${OPENSSL_ROOT_DIR} \
            -DTELEGRAM_BOT_API_ENABLE_LTO=${{ inputs.enable_lto }} \
            ..

      - name: Configure CMake (Windows)
        if: matrix.os == 'windows'
        shell: cmd
        run: |
          mkdir build
          cd build
          cmake -G "NMake Makefiles" ^
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} ^
            -DTELEGRAM_BOT_API_ENABLE_LTO=${{ inputs.enable_lto }} ^
            ..

      - name: Build
        run: |
          cd build
          cmake --build . --config ${{ inputs.build_type }} --parallel

      - name: Prepare artifact (Linux)
        if: matrix.os == 'linux'
        run: |
          cd build
          chmod +x telegram-bot-api
          tar -czf telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}.tar.gz telegram-bot-api

      - name: Prepare artifact (macOS)
        if: matrix.os == 'macos'
        run: |
          cd build
          tar -czf telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}.tar.gz telegram-bot-api

      - name: Prepare artifact (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          cd build
          Compress-Archive -Path telegram-bot-api.exe -DestinationPath telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}.zip

      - name: Upload artifact (Linux/macOS)
        if: matrix.os != 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}
          path: build/telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
          retention-days: 90

      - name: Upload artifact (Windows)
        if: matrix.os == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}
          path: build/telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}.zip
          retention-days: 90
