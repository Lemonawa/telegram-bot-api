name: Build Telegram Bot API

on:
  workflow_dispatch:
    inputs:
      enable_lto:
        description: 'Enable Link Time Optimization'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      build_type:
        description: 'Build type'
        required: false
        default: 'Release'
        type: choice
        options:
          - 'Release'
          - 'Debug'
          - 'RelWithDebInfo'
          - 'MinSizeRel'

jobs:
  build:
    name: Build on ${{ matrix.os }} ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: linux
            arch: x86_64
            runner: ubuntu-22.04
            cc: gcc
            cxx: g++

          # macOS
          - os: macos
            arch: arm64
            runner: macos-latest
            cc: clang
            cxx: clang++

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install dependencies (Linux)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            zlib1g-dev \
            libssl-dev \
            gperf

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install cmake gperf openssl@3
          # Ensure we can find openssl
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      - name: Configure CMake (Linux)
        if: matrix.os == 'linux'
        run: |
          mkdir build
          cd build
          cmake \
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DTELEGRAM_BOT_API_ENABLE_LTO=${{ inputs.enable_lto }} \
            ..

      - name: Configure CMake (macOS)
        if: matrix.os == 'macos'
        run: |
          mkdir build
          cd build
          cmake \
            -DCMAKE_BUILD_TYPE=${{ inputs.build_type }} \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DOPENSSL_ROOT_DIR=${{ env.OPENSSL_ROOT_DIR }} \
            -DTELEGRAM_BOT_API_ENABLE_LTO=${{ inputs.enable_lto }} \
            ..

      - name: Build
        run: |
          cd build
          cmake --build . --config ${{ inputs.build_type }} --parallel 2

      - name: Prepare artifact (Linux)
        if: matrix.os == 'linux'
        run: |
          cd build
          chmod +x telegram-bot-api
          tar -czf telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}.tar.gz telegram-bot-api

      - name: Prepare artifact (macOS)
        if: matrix.os == 'macos'
        run: |
          cd build
          tar -czf telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}.tar.gz telegram-bot-api

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}
          path: build/telegram-bot-api-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
          retention-days: 90
